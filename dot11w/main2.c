// gcc -o main main.c -lssl -lcrypto
#include <stdio.h>
#include <openssl/sha.h>
#include <openssl/evp.h>
#include <string.h>

#include "crypto.h"

#define DK_LEN		256
#define	PMK_LEN		DK_LEN/8
#define ITER		4096
#define EAPOL_LEN	117
#define KEY_VER		0x8a

unsigned char anonce[] = {
"\x1e\x9b\x6a\x7f\xca\xda\xe1\x68\x33\x7c\xc6" 	\
"\x0f\xc2\x50\xa1\xe5\x14\x61\xc9\x9d\x4d\x8c" 	\
"\xd8\x0c\x8d\x94\xe8\x9a\x2e\x41\xb8\x5d"	\
};

unsigned char snonce[] = {
"\xb3\x9f\x6d\xf5\xa0\xe1\x2b\x0a\xaf\xe7\x5c"	\
"\x70\x34\x1f\x76\x71\x52\x38\xde\x19\xc9\xa6"	\
"\x8b\xaa\x68\xf4\x1c\x38\x75\xd1\x46\xbc" \
};

unsigned char mic[] = \
"\x7e\xa1\x4b\x7b\x7d\x6c\x80\x53\x88\xf3\x99\x18\x9e\x48\x4f\x7c";

unsigned char eapol[] = {
"\x01\x03" \
"\x00\x75\x02\x01\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xb3" \
"\x9f\x6d\xf5\xa0\xe1\x2b\x0a\xaf\xe7\x5c\x70\x34\x1f\x76\x71\x52" \
"\x38\xde\x19\xc9\xa6\x8b\xaa\x68\xf4\x1c\x38\x75\xd1\x46\xbc\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x16\x30\x14\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac\x04\x01" \
"\x00\x00\x0f\xac\x02\x80\x00"

};

unsigned char cipher[] = {
"\x88\x41\x2c\x00\x24\x4b\xfe\xac" \
"\x1e\xf4\x2c\x6d\xc1\x32\x90\xba\xff\xff\xff\xff\xff\xff\x00\x00" \
"\x06\x00\x01\x00\x00\x20\x00\x00\x00\x00\x05\xff\x5a\x89\x5f\x78" \
"\xd2\xa7\x3a\x9b\x4a\xf6\xf9\x7c\xcc\x6e\x13\xe8\x19\x2c\xf2\xe9" \
"\xb0\x29\xec\x48\x6b\x52\xff\x99\x4d\x02\x33\x8c\xf6\x7c\x7e\xe5" \
"\x4f\x8b\xd4\xbb\x03\xb2\xb5\xeb\x58\x1d\x44\x45\x3a\x03\x5a\x5a" \
"\x4f\xc0\x7b\x16\x83\xda\x9d\x94\x6d\xcc\x40\x83\x08\x74\x7b\x92" \
"\xea\xef\x31\x5e\x4b\x2c\xed\xba\x10\x67\x43\x97\x0c\x0a\xd7\x7d" \
"\x05\x49\x0c\x58\xcc\xd5\xe4\xbf\xfd\x64\xbf\x13\x46\xc4\x4c\x9b" \
"\x8d\x1e\xa0\xae\xdf\x0c\xec\x65\x31\x55\x1a\xb2\x4e\xa8\x44\x23" \
"\xcf\x5b\x2a\x9e\xe6\xc7\x1b\xae\x44\xc7\xe7\x08\xc2\x87\x00\xc7" \
"\xd8\x93\xb8\xb2\xf6\xa8\x42\xc7\x2a\x92\xf9\x3a\xe4\xfb\x9c\x4f" \
"\xd0\x75\x9a\x10\x23\xa4\x1e\x38\x59\x96\xc9\x90\xf4\xba\x53\x53" \
"\x5d\xad\xa8\x5f\x84\x46\x6b\xa0\x11\x70\x69\xe8\x7c\x56\xea\x57" \
"\x89\x78\xd3\xd8\x85\x07\x00\x71\x56\x61\x39\x30\x0d\x7b\x5a\xf5" \
"\xc4\x53\x2e\xac\xfe\xdc\x11\x7d\x40\x2d\x61\xe3\x85\x18\x05\xbf" \
"\x3c\x58\xa6\x5d\x58\x73\x32\x71\xe7\xb3\xad\x92\x2c\x7c\x48\x5f" \
"\xac\x17\xdd\x8e\xe1\x6c\xe1\x3d\x56\xb5\x32\x6b\x10\x36\x17\x35" \
"\xaa\x0f\x4b\xee\x3a\xf9\xe3\xdc\xc2\x8e\xe9\x61\xde\x4b\xd9\x9e" \
"\xec\xd5\xff\xa7\xcc\x09\x51\x60\x57\x1c\x02\x02\x4b\xd2\x81\x11" \
"\x8e\x0b\x69\xac\x67\x50\x56\x4e\xca\x31\xd0\x83\xfa\xbd\x0c\x0b" \
"\xfb\x05\x0c\x2a\xa4\x71\x1b\x86\x2c\x7b\x51\x73\xd3\x13\xd2\x57" \
"\x3c\x4d\xfa\x78\x27\x0d\xac\x61\xd6\x61\x39\x12\x9a\x79\x4a\xf3" 
};

unsigned char apmac[] = 	"\x24\x4b\xfe\xac\x1e\xf4";
unsigned char stamac[] =	"\x2c\x6d\xc1\x32\x90\xba";


int main(void)
{
	u_char *pass = "guest1234!";
	u_char *ssid = "KITRI_DEV5";
	u_char pmk[PMK_LEN];
	u_char test_pmk[40];

	struct WPA_ST_info *st_cur = (struct WPA_ST_info*)malloc(sizeof(struct WPA_ST_info));
	
	/*	
		if(PKCS5_PBKDF2_HMAC_SHA1(pass, strlen(pass), ssid, strlen(ssid), ITER, PMK_LEN, pmk)!=1)
		{
			fprintf(stdout, "PMK Create Error\n");
			exit(-1);
		}

	
		for(int i=0; i<PMK_LEN; i++)
			printf("%x", pmk[i]);
		puts("");
	*/

	calc_pmk(pass, ssid, test_pmk);

	printf("PMK : ");
	for(int i=0; i<PMK_LEN; i++)
		printf("%x", test_pmk[i]);
	puts("");

	/* Set WPA_ST_info */
	memset(st_cur, 0, sizeof(struct WPA_ST_info));
	
	/* MAC */
	memcpy(st_cur->stmac, stamac, 6);
	memcpy(st_cur->bssid, apmac, 6);

	/* Nonce */
	memcpy(st_cur->anonce, anonce, 32);
	memcpy(st_cur->snonce, snonce, 32);

	/* EAPOL */
	st_cur->eapol_size = 121;
	memcpy(st_cur->eapol, eapol, st_cur->eapol_size);
	memcpy(st_cur->keymic, mic ,16);

	st_cur->keyver = KEY_VER;

	if(!calc_ptk(st_cur, test_pmk))
	{
		fprintf(stderr, "MIC Check Failed\n");
		exit(-1);
	}
	printf("PTK : ");
	for(int i=0; i<80; i++)
		printf("%02x", st_cur->ptk[i]);
	puts("");

	printf("TK : ");
	for(int i=0; i<16; i++)
		printf("%02x", (st_cur->ptk+32)[i]);
	puts("\n");

	decrypt_ccmp(cipher, 360, st_cur->ptk+32);

	printf("[*] Decrypted data\n");
	for(int i=0; i<360-42; i++)
	{
		printf("%02x\t", cipher[i+34]);
		if((i+1)%0xf==0 && i!=0)
			puts("");
	}

	free(st_cur);

	return 0;
}
