// gcc -o main main.c -lssl -lcrypto
#include <stdio.h>
#include <openssl/sha.h>
#include <openssl/evp.h>
#include <string.h>

#include "crypto.h"
// 802.11w
#include "supplicant/common.h"
#include "supplicant/sha256.h"
#include "supplicant/os.h"

#define DK_LEN		256
#define	PMK_LEN		DK_LEN/8
#define ITER		4096
#define EAPOL_LEN	117
#define KEY_VER		0x8a




unsigned char data[] = {
	"\x24\x4b\xfe\xac\x1e\xf4\x2c\x6d\xc1\x32\x90\xba" \
	"\x25\x9b\x1e\x6f\xc5\x4d\xd9\x69\x61\x7f\xe7\x13\xd7\x70\xf6\x1b\x28" \
	"\x26\xef\xe5\x02\x6d\xa1\xd4\x04\x18\x41\x00\xa7\x12\x14\x4f" \
	"\x47\xfb\x20\xa6\x4a\xf6\x9a\x19\xee\x82\x2b\xd7\xd0\x96\x4f\x65\x89" \
	"\x51\x50\x48\x1b\x63\xca\xe8\x12\x84\xb4\x69\xe7\xc4\xd5\x62" 
};

unsigned char anonce[] = {
"\x1e\x9b\x6a\x7f\xca\xda\xe1\x68\x33\x7c\xc6" 	\
"\x0f\xc2\x50\xa1\xe5\x14\x61\xc9\x9d\x4d\x8c" 	\
"\xd8\x0c\x8d\x94\xe8\x9a\x2e\x41\xb8\x5d"	\
};

unsigned char snonce[] = {
"\xb3\x9f\x6d\xf5\xa0\xe1\x2b\x0a\xaf\xe7\x5c"	\
"\x70\x34\x1f\x76\x71\x52\x38\xde\x19\xc9\xa6"	\
"\x8b\xaa\x68\xf4\x1c\x38\x75\xd1\x46\xbc" \
};

unsigned char mic[] = \
"\x7e\xa1\x4b\x7b\x7d\x6c\x80\x53\x88\xf3\x99\x18\x9e\x48\x4f\x7c";

unsigned char eapol[] = {
"\x01\x03" \
"\x00\x75\x02\x01\x0a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xb3" \
"\x9f\x6d\xf5\xa0\xe1\x2b\x0a\xaf\xe7\x5c\x70\x34\x1f\x76\x71\x52" \
"\x38\xde\x19\xc9\xa6\x8b\xaa\x68\xf4\x1c\x38\x75\xd1\x46\xbc\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
"\x16\x30\x14\x01\x00\x00\x0f\xac\x04\x01\x00\x00\x0f\xac\x04\x01" \
"\x00\x00\x0f\xac\x02\x80\x00"

};

unsigned char cipher[] = {
"\x88\x41\x2c\x00\x24\x4b\xfe\xac" \
"\x1e\xf4\x2c\x6d\xc1\x32\x90\xba\xff\xff\xff\xff\xff\xff\x00\x00" \
"\x06\x00\x01\x00\x00\x20\x00\x00\x00\x00\x4e\x61\x55\x51\xf1\x0a" \
"\xcb\x9a\x02\xb5\x86\x57\x15\xf1\x78\xf1\x23\xc0\x97\x72\x33\xc6" \
"\xa5\xcd\x24\xef\x22\x65\x98\x57\x1c\x30\xc9\x44\x08\x33\x6f\x2e" \
"\xe8\x65\xfc\xb4\xa6\x05\xf7\x13\xd1\xa2\xd8\x2f\x0c\xb3\x5f\xb3" \
"\x9f\x1a\x79\xed\x9b\xa7\x9c\x40\x0c\x74\x83\xf4\x2d\x0b\xce\xde" \
"\x33\x85\xa3\x57\xbd\xf3\xa1\x21\x6f\x3a\x97\x2b\x70\x8c\xbf\x53" \
"\x47\x99\x2b\xe6\x0b\xe6\xa2\xb2\xef\x46\x3e\x69\xe5\x2e\x7d\x93" \
"\xe0\x92\x60\xfc\x23\x8f\x90\x4f\x8d\x67\x78\x06\xf3\x84\x4a\x90" \
"\x1c\xc5\xdb\xe1\x76\xce\xec\x11\xe7\xad\xbb\x38\xec\x05\x18\xc7" \
"\x26\x4c\x7d\x0d\xe4\x8d\xfc\xbe\x66\x12\x7c\xcc\x49\xd3\xe2\x04" \
"\x3f\x3b\x35\xc6\xb8\x67\xc7\x1c\x2b\xe4\xcf\x4e\xcd\x71\xd4\x65" \
"\x0b\xc6\xc9\x6b\x9a\x28\xa4\xd4\xbd\x00\x66\xd8\x6b\xad\x72\x8a" \
"\x90\x5b\x47\xd5\x3a\xab\xad\xbd\xcc\xa1\x88\xa6\x28\x1e\xc2\x05" \
"\xc3\xa7\x2e\xd8\x9e\x9c\x69\xfa\xeb\xb4\x5d\xb3\x76\x23\x3a\xf8" \
"\x0e\x51\x12\xe4\x63\xbc\x98\x9d\xb3\x18\x7d\x9f\x7d\xba\xef\x0d" \
"\x07\xf9\x7c\xa7\xcf\x02\x87\xd8\xf8\x6e\x17\x3c\x73\x4d\x15\xbf" \
"\xc6\x0f\x91\x5f\x6b\x94\xec\xf9\xa4\xc7\x10\xb4\x2e\xe5\xee\x6a" \
"\x68\xa1\x1f\x28\x25\x58\x92\x87\x33\x74\xbe\x9e\xdc\xa1\x5a\xba" \
"\xfb\x94\x37\x8c\x79\xb2\x5b\x55\x0b\x66\xa4\xfc\x03\x3c\x60\x5b" \
"\xc3\x07\x58\xd6\xb4\xcb\x87\x74\x15\x5b\xca\x6d\x09\x1f\x10\x6b" \
"\xf5\x78\x2f\x9f\xec\xd2\x9f\x4f\x19\x0c\xee\xbd\xc6\x38\xde\x70" \
};

unsigned char apmac[] = 	"\x24\x4b\xfe\xac\x1e\xf4";
unsigned char stamac[] =	"\x2c\x6d\xc1\x32\x90\xba";

unsigned char PTK[48];

int main(void)
{
	u_char *pass = "guest1234!";
	u_char *ssid = "KITRI_DEV5";
	u_char pmk[PMK_LEN];
	u_char test_pmk[40];

	struct WPA_ST_info *st_cur = (struct WPA_ST_info*)malloc(sizeof(struct WPA_ST_info));
	
	/*	
		if(PKCS5_PBKDF2_HMAC_SHA1(pass, strlen(pass), ssid, strlen(ssid), ITER, PMK_LEN, pmk)!=1)
		{
			fprintf(stdout, "PMK Create Error\n");
			exit(-1);
		}

	
		for(int i=0; i<PMK_LEN; i++)
			printf("%x", pmk[i]);
		puts("");
	*/	
		calc_pmk(pass, ssid, test_pmk);
		printf("PMK : ");
		for(int i=0; i<PMK_LEN; i++)
			printf("%x", test_pmk[i]);
		puts("");

		memset(st_cur, 0, sizeof(struct WPA_ST_info));
		
		memcpy(st_cur->stmac, stamac, 6);
		memcpy(st_cur->bssid, apmac, 6);

		memcpy(st_cur->anonce, anonce, 32);
		memcpy(st_cur->snonce, snonce, 32);

		st_cur->eapol_size = 121;
		memcpy(st_cur->eapol, eapol, st_cur->eapol_size);
		memcpy(st_cur->keymic, mic ,16);

		st_cur->keyver = KEY_VER;

		/*
			if(!calc_ptk(st_cur, test_pmk))
			{
				fprintf(stderr, "MIC Check Failed\n");
				exit(-1);
			}
		*/

		sha256_prf(test_pmk, PMK_LEN, "Pairwise key expansion", data, 76, PTK, 48);


		printf("PTK : ");
		for(int i=0; i<48; i++)
			printf("%02x", PTK[i]);
		puts("");

		printf("TK : ");
		for(int i=0; i<16; i++)
			printf("%02x", (PTK+32)[i]);
		puts("\n");

		decrypt_ccmp(cipher, 360, PTK+32);

		printf("[*] Decrypted data\n");
		for(int i=0; i<360-42; i++)
		{
			printf("%02x\t", cipher[i+34]);
			if((i+1)%0xf==0 && i!=0)
				puts("");
		}


	free(st_cur);

	return 0;
}
